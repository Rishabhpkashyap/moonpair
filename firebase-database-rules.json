{
  "rules": {
    "users": {
      "$userId": {
        ".read": "auth != null && (auth.uid == $userId || root.child('users').child(auth.uid).child('partner').child('partnerId').val() == $userId)",
        ".write": "auth != null && auth.uid == $userId",
        
        "profile": {
          ".read": "auth != null",
          ".validate": "newData.hasChildren(['name', 'email'])",
          "name": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 50"
          },
          "email": {
            ".validate": "newData.isString()"
          },
          "nickname": {
            ".validate": "newData.isString() && newData.val().length <= 20"
          },
          "photoURL": {
            ".validate": "newData.isString() || newData.val() == null"
          },
          "gender": {
            ".validate": "newData.isString() && (newData.val() == 'male' || newData.val() == 'female')"
          }
        },
        
        "cycle": {
          ".read": "auth != null && (auth.uid == $userId || root.child('users').child(auth.uid).child('partner').child('partnerId').val() == $userId)",
          ".write": "auth != null && auth.uid == $userId",
          
          "cycleLength": {
            ".validate": "newData.isNumber() && newData.val() >= 1"
          },
          "periodLength": {
            ".validate": "newData.isNumber() && newData.val() >= 1"
          },
          "lastPeriodStart": {
            ".validate": "newData.isString() || newData.val() == null"
          },
          "lastPeriodEnd": {
            ".validate": "newData.isString() || newData.val() == null"
          },
          "history": {
            "$entryId": {
              "startDate": {
                ".validate": "newData.isString()"
              },
              "endDate": {
                ".validate": "newData.isString() || newData.val() == null"
              }
            }
          }
        },
        
        "partner": {
          ".read": "auth != null && auth.uid == $userId",
          ".write": "auth != null",
          
          "partnerId": {
            ".validate": "newData.isString()"
          },
          "partnerEmail": {
            ".validate": "newData.isString() || newData.val() == null"
          },
          "partnerName": {
            ".validate": "newData.isString()"
          },
          "connectedAt": {
            ".validate": "newData.isNumber()"
          }
        },
        
        "role": {
          ".validate": "newData.isString()"
        },
        
        "settings": {
          "theme": {
            ".validate": "newData.isString()"
          },
          "notifications": {
            ".validate": "newData.isBoolean()"
          }
        }
      }
    },
    
    "chats": {
      "$chatId": {
        ".read": "auth != null && $chatId.contains(auth.uid)",
        ".write": "auth != null && $chatId.contains(auth.uid)",
        
        "messages": {
          "$messageId": {
            "text": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 2000"
            },
            "senderId": {
              ".validate": "newData.isString() && newData.val() == auth.uid"
            },
            "timestamp": {
              ".validate": "newData.isNumber()"
            },
            "status": {
              ".validate": "newData.isString()"
            }
          }
        },
        
        "metadata": {
          "$metaId": {
            "lastMessage": {
              ".validate": "newData.isString()"
            },
            "lastMessageTime": {
              ".validate": "newData.isNumber()"
            },
            "lastMessageSender": {
              ".validate": "newData.isString()"
            }
          }
        }
      }
    },
    
    "inviteCodes": {
      "$code": {
        ".read": "auth != null",
        ".write": "auth != null",
        
        "createdBy": {
          ".validate": "newData.isString()"
        },
        "createdByEmail": {
          ".validate": "newData.isString() || newData.val() == null"
        },
        "createdByName": {
          ".validate": "newData.isString()"
        },
        "createdAt": {
          ".validate": "newData.isNumber()"
        },
        "expiresAt": {
          ".validate": "newData.isNumber()"
        },
        "used": {
          ".validate": "newData.isBoolean()"
        },
        "usedBy": {
          ".validate": "newData.isString() || newData.val() == null"
        },
        "usedAt": {
          ".validate": "newData.isNumber() || newData.val() == null"
        }
      }
    },
    
    "$other": {
      ".read": false,
      ".write": false
    }
  }
}
