{
  "rules": {
    "users": {
      "$userId": {
        ".read": "auth != null && (auth.uid == $userId || root.child('users').child(auth.uid).child('partner').child('partnerId').val() == $userId)",
        ".write": "auth != null && auth.uid == $userId",
        
        "profile": {
          ".read": "auth != null && (auth.uid == $userId || root.child('users').child(auth.uid).child('partner').child('partnerId').val() == $userId)",
          ".validate": "newData.hasChildren(['name', 'email'])",
          "name": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 50"
          },
          "email": {
            ".validate": "newData.isString() && newData.val().matches(/^[^@]+@[^@]+\\.[^@]+$/)"
          },
          "nickname": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 20"
          },
          "photoURL": {
            ".validate": "newData.isString() || newData.val() == null"
          },
          "gender": {
            ".validate": "newData.isString() && (newData.val() == 'male' || newData.val() == 'female')"
          }
        },
        
        "cycle": {
          ".read": "auth != null && (auth.uid == $userId || root.child('users').child(auth.uid).child('partner').child('partnerId').val() == $userId)",
          ".write": "auth != null && auth.uid == $userId",
          ".validate": "newData.hasChildren() || newData.val() == null",
          
          "cycleLength": {
            ".validate": "newData.isNumber() && newData.val() >= 1"
          },
          "periodLength": {
            ".validate": "newData.isNumber() && newData.val() >= 3 && newData.val() <= 8"
          },
          "lastPeriodStart": {
            ".validate": "newData.isString() && newData.val().matches(/^\\d{4}-\\d{2}-\\d{2}$/) || newData.val() == null"
          },
          "lastPeriodEnd": {
            ".validate": "newData.isString() && newData.val().matches(/^\\d{4}-\\d{2}-\\d{2}$/) || newData.val() == null"
          },
          "history": {
            "$entryId": {
              ".validate": "newData.hasChildren(['startDate'])",
              "startDate": {
                ".validate": "newData.isString() && newData.val().matches(/^\\d{4}-\\d{2}-\\d{2}$/)"
              },
              "endDate": {
                ".validate": "newData.isString() && newData.val().matches(/^\\d{4}-\\d{2}-\\d{2}$/) || newData.val() == null"
              }
            }
          }
        },
        
        "partner": {
          ".read": "auth != null && auth.uid == $userId",
          ".write": "auth != null && (auth.uid == $userId || root.child('users').child($userId).child('partner').child('partnerId').val() == auth.uid)",
          ".validate": "newData.hasChildren(['partnerId', 'partnerName', 'connectedAt']) || newData.val() == null",
          
          "partnerId": {
            ".validate": "newData.isString() && newData.val().length > 0"
          },
          "partnerEmail": {
            ".validate": "newData.isString() && newData.val().matches(/^[^@]+@[^@]+\\.[^@]+$/) || newData.val() == null"
          },
          "partnerName": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 50"
          },
          "connectedAt": {
            ".validate": "newData.isNumber()"
          }
        },
        
        "role": {
          ".validate": "newData.isString() && (newData.val() == 'primary' || newData.val() == 'partner')"
        },
        
        "settings": {
          ".validate": "newData.hasChildren() || newData.val() == null",
          "theme": {
            ".validate": "newData.isString() && (newData.val() == 'light' || newData.val() == 'dark')"
          },
          "notifications": {
            ".validate": "newData.isBoolean()"
          }
        }
      }
    },
    
    "chats": {
      "$chatId": {
        ".read": "auth != null && $chatId.contains(auth.uid)",
        ".write": "auth != null && $chatId.contains(auth.uid)",
        
        "messages": {
          "$messageId": {
            ".validate": "newData.hasChildren(['text', 'senderId', 'timestamp'])",
            "text": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 2000"
            },
            "senderId": {
              ".validate": "newData.isString() && newData.val() == auth.uid"
            },
            "timestamp": {
              ".validate": "newData.isNumber() && newData.val() <= now + 60000"
            },
            "status": {
              ".validate": "newData.isString() && (newData.val() == 'sent' || newData.val() == 'delivered' || newData.val() == 'read')"
            }
          }
        },
        
        "metadata": {
          ".validate": "newData.hasChildren() || newData.val() == null",
          "$metaId": {
            "lastMessage": {
              ".validate": "newData.isString() && newData.val().length <= 2000"
            },
            "lastMessageTime": {
              ".validate": "newData.isNumber()"
            },
            "lastMessageSender": {
              ".validate": "newData.isString() && newData.val() == auth.uid"
            }
          }
        }
      }
    },
    
    "inviteCodes": {
      "$code": {
        ".read": "auth != null",
        ".write": "auth != null && (!data.exists() || data.child('createdBy').val() == auth.uid || (data.child('used').val() == false && newData.child('usedBy').val() == auth.uid))",
        ".validate": "newData.hasChildren(['createdBy', 'createdAt', 'expiresAt', 'used']) || newData.val() == null",
        
        "createdBy": {
          ".validate": "newData.isString() && newData.val() == auth.uid"
        },
        "createdByEmail": {
          ".validate": "newData.isString() && newData.val().matches(/^[^@]+@[^@]+\\.[^@]+$/) || newData.val() == null"
        },
        "createdByName": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 50"
        },
        "createdAt": {
          ".validate": "newData.isNumber() && newData.val() <= now + 60000"
        },
        "expiresAt": {
          ".validate": "newData.isNumber()"
        },
        "used": {
          ".validate": "newData.isBoolean()"
        },
        "usedBy": {
          ".validate": "newData.isString() || newData.val() == null"
        },
        "usedAt": {
          ".validate": "newData.isNumber() || newData.val() == null"
        }
      }
    },
    
    "$other": {
      ".read": false,
      ".write": false
    }
  }
}
